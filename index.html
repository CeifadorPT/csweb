<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CS Helper - Player Monitor</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0f0f23;
            --secondary-bg: #1a1a2e;
            --accent-color: #00d4ff;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --danger-color: #ff4757;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --glow: 0 0 20px rgba(0, 212, 255, 0.3);
            --t-side-color: #ff6b35;
            --ct-side-color: #4ecdc4;
            --background-image: url('images/data/de_dust2/background.png');
            --background-opacity: 0.3;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background-image 0.5s ease;
        }

        /* Background image - will be set dynamically via JavaScript */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background-image, url('images/data/de_dust2/background.png')) center center;
            background-size: cover;
            opacity: var(--background-opacity, 0.3);
            z-index: -1;
            transition: all 0.5s ease;
        }

        .main-container {
            display: flex;
            height: 100vh;
            padding: 20px;
            gap: 20px;
            box-sizing: border-box;
        }

        /* Left side - Terrorist team */
        .team-side {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .team-header {
            text-align: center;
            padding: 15px;
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .team-header.t-side {
            border-color: var(--t-side-color);
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
        }

        .team-header.ct-side {
            border-color: var(--ct-side-color);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        }

        .team-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .team-title.t-side {
            color: var(--t-side-color);
        }

        .team-title.ct-side {
            color: var(--ct-side-color);
        }

        .team-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .players-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
        }

        .player-card {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: visible;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow), var(--glow);
        }

        .player-card.dead {
            opacity: 0.6;
            background: rgba(128, 128, 128, 0.1);
        }

        .player-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            width: 100%;
            box-sizing: border-box;
        }

        .player-stats-top {
            margin-left: auto;
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .player-ping {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .player-kills {
            font-size: 0.8rem;
            color: var(--accent-color);
            font-weight: 600;
        }

        .player-avatar {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--card-border);
            flex-shrink: 0;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-info {
            flex: 1;
            min-width: 0;
        }

        .player-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-weapon-display {
            margin-bottom: 4px;
            display: flex;
            justify-content: left;
        }

        .player-weapon-display img {
            width: 28px;
            height: 28px;
            filter: brightness(0) invert(1); /* Make SVG icons white */
            opacity: 0.8;
        }

        .player-team-indicator {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid;
        }

        .player-team-indicator.t-side {
            border-top-color: var(--t-side-color);
        }

        .player-team-indicator.ct-side {
            border-top-color: var(--ct-side-color);
        }

        .player-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: -15px;
            width: 100%;
            box-sizing: border-box;
        }

        .player-money {
            color: var(--success-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .player-health-armor {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .health-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--success-color);
            font-weight: 600;
        }

        .armor-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--accent-color);
            font-weight: 600;
        }

        .health-bar-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin-top: 12px;
            margin-bottom: 16px;
            width: 100%;
            box-sizing: border-box;
        }

        .health-bar {
            height: 100%;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: var(--success-color);
            min-width: 8px;
            box-sizing: border-box;
        }

        .health-bar.low {
            background: var(--warning-color);
        }

        .health-bar.critical {
            background: var(--danger-color);
        }

        .weapons-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
            box-sizing: border-box;
        }

        .weapon-slot {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--card-border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.7rem;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .weapon-slot.has-weapon {
            background: rgba(0, 212, 255, 0.2);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .weapon-slot.armor {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00FF00;
            color: #00FF00;
        }

        .weapon-slot.helmet {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00FF00;
            color: var(--success-color);
        }

        .weapon-slot.defuser {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00FF00;
            color: #00FF00;
        }

        .weapon-icon {
            width: 16px;
            height: 16px;
            filter: brightness(0) invert(1); /* Make SVG icons white */
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .weapon-slot:hover .weapon-icon {
            opacity: 1;
        }

        .weapon-slot.has-weapon .weapon-icon {
            filter: brightness(0) invert(1); /* Make all weapon icons white */
        }

        .weapon-slot.armor .weapon-icon {
            filter: brightness(0) invert(1); /* Make all icons white */
        }

        .weapon-slot.helmet .weapon-icon {
            filter: brightness(0) invert(1); /* Make all icons white */
        }

        .weapon-slot.defuser .weapon-icon {
            filter: brightness(0) invert(1); /* Make all icons white */
        }

        /* Center - Radar */
        .radar-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .radar-header {
            text-align: center;
            padding: 15px;
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .radar-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .radar-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .map-selector {
            display: flex;
            justify-content: center;
            margin-top: 8px;
        }

        .map-selector select {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        .map-selector select:hover {
            border-color: var(--accent-color);
        }

        .map-selector select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
        }

        /* Dropdown options styling */
        .map-selector select option {
            background: var(--secondary-bg);
            color: var(--text-primary);
            border: none;
            padding: 8px 12px;
        }

        .map-selector select option:hover {
            background: var(--accent-color);
            color: var(--primary-bg);
        }

        .radar-container {
            flex: 1;
            background: transparent;
            backdrop-filter: blur(15px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .kill-feed {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 300px;
        }

        .kill-feed-entry {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: killFeedSlideIn 0.3s ease-out;
            max-width: 100%;
            overflow: hidden;
        }

        .kill-feed-entry .player-name {
            color: #00FF00;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .kill-feed-entry .kill-count {
            color: #FFD700;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .kill-feed-entry .victim-name {
            color: #FF6B6B;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .kill-feed-entry .weapon-icon {
            width: 24px;
            height: 24px;
            filter: brightness(0) invert(1);
            opacity: 0.9;
        }

        @keyframes killFeedSlideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes killFeedSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(-100%);
                opacity: 0;
            }
        }

        .radar-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #radarImage {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            border-radius: 10px;
            display: block;
            object-fit: contain;
        }

        .radar-player {
            position: absolute;
            width: 12px;
            height: 12px;
            transform: translate(-50%, -50%);
            z-index: 10;
            transition: all 0.1s linear;
        }

        .radar-player-container {
            z-index: 10;
            transition: all 0.1s linear;
        }

        .radar-player-teardrop {
            width: 12px;
            height: 12px;
            border-radius: 50% 50% 50% 0%;
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.1s linear;
            position: relative;
        }

        .radar-player-teardrop.enemy {
            background: red;
        }

        .radar-player-name {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 1px 4px;
            border-radius: 2px;
            white-space: nowrap;
            margin-bottom: 2px;
        }

        .radar-player-weapon {
            position: absolute;
            bottom: 200%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9;
            pointer-events: none;
        }

        .radar-player-weapon img {
            width: 32px;
            height: 32px;
            filter: brightness(0) invert(1); /* Make SVG icons white */
            opacity: 0.9;
        }

        .radar-player-health {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 8;
            pointer-events: none;
            width: 20px;
            height: 4px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 2px;
            overflow: hidden;
        }

        .radar-health-bar {
            height: 100%;
            border-radius: 2px;
            transition: all 0.2s ease;
            background: var(--success-color);
            min-width: 2px;
        }

        .radar-health-bar.low {
            background: var(--warning-color);
        }

        .radar-health-bar.critical {
            background: var(--danger-color);
        }

        .radar-placeholder {
            text-align: center;
            color: var(--text-secondary);
        }

        .radar-placeholder i {
            font-size: 4rem;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .radar-placeholder h3 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .radar-placeholder p {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Right side - Counter-Terrorist team */
        .team-side.ct-side {
            order: 3;
        }

        /* Connection status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .status.connected {
            background: rgba(0, 255, 136, 0.1);
            color: var(--success-color);
            border-color: var(--success-color);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        .status.disconnected {
            background: rgba(255, 71, 87, 0.1);
            color: var(--danger-color);
            border-color: var(--danger-color);
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.3);
        }

        .status i {
            font-size: 0.8rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Mobile responsive design */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                gap: 16px;
                padding: 16px;
                height: auto;
                min-height: 100vh;
            }

            .team-side {
                order: 1;
                width: 100%;
                max-width: none;
                min-width: 300px;
            }

            .radar-section {
                order: 2;
                width: 100%;
                max-width: none;
                min-height: 350px;
            }

            .radar-container {
                height: 300px;
                min-height: 300px;
            }

            .radar-wrapper {
                width: 100%;
                height: 100%;
                min-width: 300px;
                min-height: 300px;
            }

            .radar-image {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            .player-card {
                padding: 20px;
                margin-bottom: 16px;
                min-height: 180px;
            }

            .player-header {
                flex-direction: row;
                align-items: flex-start;
                gap: 16px;
                flex-wrap: wrap;
                margin-bottom: 20px;
            }

            .player-info {
                flex: 1;
                min-width: 200px;
            }

            .player-stats-top {
                margin-left: auto;
                margin-top: 0;
                align-self: flex-start;
                flex-shrink: 0;
            }

            .player-avatar {
                width: 40px;
                height: 40px;
                flex-shrink: 0;
            }

            .player-name {
                font-size: 1rem;
                margin-bottom: 6px;
            }

            .player-weapon-display img {
                width: 24px;
                height: 24px;
            }

            .weapons-row {
                gap: 8px;
                margin-top: 12px;
                justify-content: center;
            }

            .weapon-slot {
                width: 24px;
                height: 24px;
                flex-shrink: 0;
            }

            .player-stats {
                margin-bottom: 20px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .player-money {
                font-size: 1rem;
            }

            .player-health-armor {
                gap: 12px;
            }

            .health-bar-container {
                margin-top: 16px;
                margin-bottom: 20px;
            }

            .map-selector select {
                min-width: 100px;
                font-size: 0.8rem;
            }

            .radar-header {
                flex-direction: column;
                gap: 12px;
                align-items: center;
            }

            .radar-title, .radar-subtitle {
                text-align: center;
            }

            .kill-feed {
                top: 15px;
                left: 15px;
                max-width: 250px;
            }

            .kill-feed-entry {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            .kill-feed-entry .weapon-icon {
                width: 20px;
                height: 20px;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: 12px;
            }

            .radar-container {
                height: 250px;
                min-height: 250px;
            }

            .radar-wrapper {
                width: 100% !important;
                height: 100% !important;
                min-width: 250px !important;
                min-height: 250px !important;
            }

            #radarImage {
                width: 100% !important;
                height: 100% !important;
                object-fit: contain;
            }

            .player-card {
                padding: 14px;
                margin-bottom: 10px;
            }

            .player-header {
                gap: 10px;
            }

            .player-info {
                min-width: 150px;
            }

            .player-avatar {
                width: 36px;
                height: 36px;
            }

            .player-name {
                font-size: 0.95rem;
                margin-bottom: 4px;
            }

            .player-weapon-display img {
                width: 22px;
                height: 22px;
            }

            .player-stats-top {
                font-size: 0.75rem;
            }

            .weapon-slot {
                width: 22px;
                height: 22px;
            }

            .weapons-row {
                gap: 6px;
                margin-top: 10px;
            }

            .radar-player-name {
                font-size: 8px;
                padding: 1px 3px;
            }

            .radar-player-weapon img {
                width: 24px;
                height: 24px;
            }

            .radar-player-health {
                width: 18px;
                height: 3px;
                top: 20px;
            }
        }

        /* Scrollbar styling */
        .players-list::-webkit-scrollbar {
            width: 6px;
        }

        .players-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .players-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .players-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
                height: auto;
                overflow-y: auto;
            }

            .team-side {
                width: 100%;
                max-height: 300px;
            }

            .radar-section {
                order: 2;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
                gap: 15px;
            }

            .player-card {
                padding: 12px;
            }

            .player-avatar {
                width: 40px;
                height: 40px;
            }

            .player-name {
                font-size: 1rem;
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="connection-status">
                <div class="status" id="connectionStatus">
                    <i class="fas fa-circle"></i>
                    <span>Connecting...</span>
            </div>
        </div>

    <div class="main-container">
        <!-- Left side - Terrorist team -->
        <div class="team-side">
            <div class="team-header t-side">
                <div class="team-title">TERRORISTS</div>
                <div class="team-count" id="tCount">0 players</div>
            </div>
            <div class="players-list" id="tPlayersList">
                <!-- T players will be populated here -->
            </div>
        </div>

        <!-- Center - Radar -->
        <div class="radar-section">
            <div class="radar-header">
                <div class="radar-title">LIVE RADAR</div>
                <div class="radar-subtitle">Real-time player positions</div>
                <div class="map-selector">
                    <select id="mapSelect" onchange="changeMap(this.value)">
                        <option value="de_dust2">de_dust2</option>
                        <option value="de_mirage">de_mirage</option>
                        <option value="de_inferno">de_inferno</option>
                        <option value="de_nuke">de_nuke</option>
                        <option value="de_overpass">de_overpass</option>
                        <option value="de_vertigo">de_vertigo</option>
                        <option value="de_ancient">de_ancient</option>
                        <option value="de_anubis">de_anubis</option>
                        <option value="de_train">de_train</option>
                        <option value="de_mills">de_mills</option>
                        <option value="de_jura">de_jura</option>
                        <option value="de_grail">de_grail</option>
                        <option value="de_thera">de_thera</option>
                        <option value="cs_agency">cs_agency</option>
                        <option value="cs_italy">cs_italy</option>
                        <option value="cs_office">cs_office</option>
                    </select>
                </div>
            </div>
                        <div class="radar-container">
                <div class="kill-feed" id="killFeed">
                    <!-- Kill feed entries will be added here -->
                </div>
                <div class="radar-wrapper" id="radarWrapper">
                    <img id="radarImage" src="images/data/de_dust2/radar.png" alt="Map Radar">
                </div>
            </div>
        </div>

        <!-- Right side - Counter-Terrorist team -->
        <div class="team-side ct-side">
            <div class="team-header ct-side">
                <div class="team-title">COUNTER-TERRORISTS</div>
                <div class="team-count" id="ctCount">0 players</div>
            </div>
            <div class="players-list" id="ctPlayersList">
                <!-- CT players will be populated here -->
        </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4Bv1wze0YBxsdZ8H8CHk3z9exbfhkC3I",
            authDomain: "pisell-25c62.firebaseapp.com",
            databaseURL: "https://pisell-25c62-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pisell-25c62",
            storageBucket: "pisell-25c62.firebasestorage.app",
            messagingSenderId: "499486425001",
            appId: "1:499486425001:web:9855c127bd845e35d88eb8",
            measurementId: "G-6PW3W83FBP"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM elements
        const connectionStatus = document.getElementById('connectionStatus');
        const tPlayersList = document.getElementById('tPlayersList');
        const ctPlayersList = document.getElementById('ctPlayersList');
        const tCount = document.getElementById('tCount');
        const ctCount = document.getElementById('ctCount');

        // Character model mapping (based on your C++ code)
        const characterModels = {
            // CT models
            'models/player/custom_player/legacy/ctm_diver_varianta.mdl': 'ctm_diver_varianta.png',
            'models/player/custom_player/legacy/ctm_diver_variantb.mdl': 'ctm_diver_variantb.png',
            'models/player/custom_player/legacy/ctm_diver_variantc.mdl': 'ctm_diver_variantc.png',
            'models/player/custom_player/legacy/ctm_fbi.mdl': 'ctm_fbi.png',
            'models/player/custom_player/legacy/ctm_fbi_varianta.mdl': 'ctm_fbi_varianta.png',
            'models/player/custom_player/legacy/ctm_fbi_variantb.mdl': 'ctm_fbi_variantb.png',
            'models/player/custom_player/legacy/ctm_fbi_variantc.mdl': 'ctm_fbi_variantc.png',
            'models/player/custom_player/legacy/ctm_fbi_variantd.mdl': 'ctm_fbi_variantd.png',
            'models/player/custom_player/legacy/ctm_fbi_variante.mdl': 'ctm_fbi_variante.png',
            'models/player/custom_player/legacy/ctm_fbi_variantf.mdl': 'ctm_fbi_variantf.png',
            'models/player/custom_player/legacy/ctm_fbi_variantg.mdl': 'ctm_fbi_variantg.png',
            'models/player/custom_player/legacy/ctm_fbi_varianth.mdl': 'ctm_fbi_varianth.png',
            'models/player/custom_player/legacy/ctm_gendarmerie_varianta.mdl': 'ctm_gendarmerie_varianta.png',
            'models/player/custom_player/legacy/ctm_gendarmerie_variantb.mdl': 'ctm_gendarmerie_variantb.png',
            'models/player/custom_player/legacy/ctm_gendarmerie_variantc.mdl': 'ctm_gendarmerie_variantc.png',
            'models/player/custom_player/legacy/ctm_gendarmerie_variantd.mdl': 'ctm_gendarmerie_variantd.png',
            'models/player/custom_player/legacy/ctm_gendarmerie_variante.mdl': 'ctm_gendarmerie_variante.png',
            'models/player/custom_player/legacy/ctm_heavy.mdl': 'ctm_heavy.png',
            'models/player/custom_player/legacy/ctm_sas.mdl': 'ctm_sas.png',
            'models/player/custom_player/legacy/ctm_sas_variantf.mdl': 'ctm_sas_variantf.png',
            'models/player/custom_player/legacy/ctm_sas_variantg.mdl': 'ctm_sas_variantg.png',
            'models/player/custom_player/legacy/ctm_st6.mdl': 'ctm_st6.png',
            'models/player/custom_player/legacy/ctm_st6_varianta.mdl': 'ctm_st6_varianta.png',
            'models/player/custom_player/legacy/ctm_st6_variantb.mdl': 'ctm_st6_variantb.png',
            'models/player/custom_player/legacy/ctm_st6_variantc.mdl': 'ctm_st6_variantc.png',
            'models/player/custom_player/legacy/ctm_st6_variantd.mdl': 'ctm_st6_variantd.png',
            'models/player/custom_player/legacy/ctm_st6_variante.mdl': 'ctm_st6_variante.png',
            'models/player/custom_player/legacy/ctm_st6_variantf.mdl': 'ctm_st6_variantf.png',
            'models/player/custom_player/legacy/ctm_st6_variantg.mdl': 'ctm_st6_variantg.png',
            'models/player/custom_player/legacy/ctm_st6_varianth.mdl': 'ctm_st6_varianth.png',
            'models/player/custom_player/legacy/ctm_st6_varianti.mdl': 'ctm_st6_varianti.png',
            'models/player/custom_player/legacy/ctm_st6_variantj.mdl': 'ctm_st6_variantj.png',
            'models/player/custom_player/legacy/ctm_st6_variantk.mdl': 'ctm_st6_variantk.png',
            'models/player/custom_player/legacy/ctm_st6_variantl.mdl': 'ctm_st6_variantl.png',
            'models/player/custom_player/legacy/ctm_st6_variantm.mdl': 'ctm_st6_variantm.png',
            'models/player/custom_player/legacy/ctm_st6_variantn.mdl': 'ctm_st6_variantn.png',
            'models/player/custom_player/legacy/ctm_swat_variante.mdl': 'ctm_swat_variante.png',
            'models/player/custom_player/legacy/ctm_swat_variantf.mdl': 'ctm_swat_variantf.png',
            'models/player/custom_player/legacy/ctm_swat_variantg.mdl': 'ctm_swat_variantg.png',
            'models/player/custom_player/legacy/ctm_swat_varianth.mdl': 'ctm_swat_varianth.png',
            'models/player/custom_player/legacy/ctm_swat_varianti.mdl': 'ctm_swat_varianti.png',
            'models/player/custom_player/legacy/ctm_swat_variantj.mdl': 'ctm_swat_variantj.png',
            'models/player/custom_player/legacy/ctm_swat_variantk.mdl': 'ctm_swat_variantk.png',
            
            // T models
            'models/player/custom_player/legacy/tm_anarchist.mdl': 'tm_anarchist.png',
            'models/player/custom_player/legacy/tm_anarchist_varianta.mdl': 'tm_anarchist_varianta.png',
            'models/player/custom_player/legacy/tm_anarchist_variantb.mdl': 'tm_anarchist_variantb.png',
            'models/player/custom_player/legacy/tm_anarchist_variantc.mdl': 'tm_anarchist_variantc.png',
            'models/player/custom_player/legacy/tm_anarchist_variantd.mdl': 'tm_anarchist_variantd.png',
            'models/player/custom_player/legacy/tm_balkan_varianta.mdl': 'tm_balkan_varianta.png',
            'models/player/custom_player/legacy/tm_balkan_variantb.mdl': 'tm_balkan_variantb.png',
            'models/player/custom_player/legacy/tm_balkan_variantc.mdl': 'tm_balkan_variantc.png',
            'models/player/custom_player/legacy/tm_balkan_variantd.mdl': 'tm_balkan_variantd.png',
            'models/player/custom_player/legacy/tm_balkan_variante.mdl': 'tm_balkan_variante.png',
            'models/player/custom_player/legacy/tm_balkan_variantf.mdl': 'tm_balkan_variantf.png',
            'models/player/custom_player/legacy/tm_balkan_variantg.mdl': 'tm_balkan_variantg.png',
            'models/player/custom_player/legacy/tm_balkan_varianth.mdl': 'tm_balkan_varianth.png',
            'models/player/custom_player/legacy/tm_balkan_varianti.mdl': 'tm_balkan_varianti.png',
            'models/player/custom_player/legacy/tm_balkan_variantj.mdl': 'tm_balkan_variantj.png',
            'models/player/custom_player/legacy/tm_balkan_variantk.mdl': 'tm_balkan_variantk.png',
            'models/player/custom_player/legacy/tm_balkan_variantl.mdl': 'tm_balkan_variantl.png',
            'models/player/custom_player/legacy/tm_jumpsuit_varianta.mdl': 'tm_jumpsuit_varianta.png',
            'models/player/custom_player/legacy/tm_jumpsuit_variantb.mdl': 'tm_jumpsuit_variantb.png',
            'models/player/custom_player/legacy/tm_jumpsuit_variantc.mdl': 'tm_jumpsuit_variantc.png',
            'models/player/custom_player/legacy/tm_jungle_raider_varianta.mdl': 'tm_jungle_raider_varianta.png',
            'models/player/custom_player/legacy/tm_jungle_raider_variantb.mdl': 'tm_jungle_raider_variantb.png',
            'models/player/custom_player/legacy/tm_jungle_raider_variantb2.mdl': 'tm_jungle_raider_variantb2.png',
            'models/player/custom_player/legacy/tm_jungle_raider_variantc.mdl': 'tm_jungle_raider_variantc.png',
            'models/player/custom_player/legacy/tm_jungle_raider_variantd.mdl': 'tm_jungle_raider_variantd.png',
            'models/player/custom_player/legacy/tm_jungle_raider_variante.mdl': 'tm_jungle_raider_variante.png',
            'models/player/custom_player/legacy/tm_jungle_raider_variantf.mdl': 'tm_jungle_raider_variantf.png',
            'models/player/custom_player/legacy/tm_jungle_raider_variantf2.mdl': 'tm_jungle_raider_variantf2.png',
            'models/player/custom_player/legacy/tm_leet_variantf.mdl': 'tm_leet_variantf.png',
            'models/player/custom_player/legacy/tm_leet_variantg.mdl': 'tm_leet_variantg.png',
            'models/player/custom_player/legacy/tm_leet_varianth.mdl': 'tm_leet_varianth.png',
            'models/player/custom_player/legacy/tm_leet_varianti.mdl': 'tm_leet_varianti.png',
            'models/player/custom_player/legacy/tm_leet_variantj.mdl': 'tm_leet_variantj.png',
            'models/player/custom_player/legacy/tm_phoenix.mdl': 'tm_phoenix.png',
            'models/player/custom_player/legacy/tm_phoenix_heavy.mdl': 'tm_phoenix_heavy.png',
            'models/player/custom_player/legacy/tm_phoenix_varianta.mdl': 'tm_phoenix_varianta.png',
            'models/player/custom_player/legacy/tm_phoenix_variantb.mdl': 'tm_phoenix_variantb.png',
            'models/player/custom_player/legacy/tm_phoenix_variantc.mdl': 'tm_phoenix_variantc.png',
            'models/player/custom_player/legacy/tm_phoenix_variantd.mdl': 'tm_phoenix_variantd.png',
            'models/player/custom_player/legacy/tm_phoenix_variantf.mdl': 'tm_phoenix_variantf.png',
            'models/player/custom_player/legacy/tm_phoenix_variantg.mdl': 'tm_phoenix_variantg.png',
            'models/player/custom_player/legacy/tm_phoenix_varianth.mdl': 'tm_phoenix_varianth.png',
            'models/player/custom_player/legacy/tm_phoenix_varianti.mdl': 'tm_phoenix_varianti.png',
            'models/player/custom_player/legacy/tm_professional_varf.mdl': 'tm_professional_varf.png',
            'models/player/custom_player/legacy/tm_professional_varf1.mdl': 'tm_professional_varf1.png',
            'models/player/custom_player/legacy/tm_professional_varf2.mdl': 'tm_professional_varf2.png',
            'models/player/custom_player/legacy/tm_professional_varf3.mdl': 'tm_professional_varf3.png',
            'models/player/custom_player/legacy/tm_professional_varf4.mdl': 'tm_professional_varf4.png',
            'models/player/custom_player/legacy/tm_professional_varf5.mdl': 'tm_professional_varf5.png',
            'models/player/custom_player/legacy/tm_professional_varg.mdl': 'tm_professional_varg.png',
            'models/player/custom_player/legacy/tm_professional_varh.mdl': 'tm_professional_varh.png',
            'models/player/custom_player/legacy/tm_professional_vari.mdl': 'tm_professional_vari.png',
            'models/player/custom_player/legacy/tm_professional_varj.mdl': 'tm_professional_varj.png'
        };

        // Utility functions
        function getHealthColor(health) {
            if (health > 75) return '#00ff88';
            if (health > 50) return '#ffaa00';
            if (health > 25) return '#ff4757';
            return '#ff0000';
        }

        function getHealthClass(health) {
            if (health > 75) return '';
            if (health > 50) return 'low';
            if (health > 25) return 'critical';
            return 'critical';
        }

        function getCharacterImage(modelName) {
            if (!modelName) return 'images/characters/ctm_fbi.png';
            
            // Extract the model name from the full path
            const modelPath = modelName.toLowerCase();
            
            // Try to find exact match first
            for (const [key, value] of Object.entries(characterModels)) {
                if (modelPath.includes(key.toLowerCase().split('/').pop().replace('.mdl', ''))) {
                    return `images/characters/${value}`;
                }
            }
            
            // Fallback based on team prefix
            if (modelPath.includes('ctm_')) {
                return 'images/characters/ctm_fbi.png';
            } else if (modelPath.includes('tm_')) {
                return 'images/characters/tm_phoenix.png';
            }
            
            return 'images/characters/ctm_fbi.png';
        }

        function getWeaponIcon(weaponName) {
            if (!weaponName) return '<i class="fas fa-question"></i>';
            
            const weapon = weaponName.toLowerCase();
            
            // Primary weapons (rifles, SMGs, shotguns, snipers)
            if (weapon.includes('ak47')) {
                return '<img src="images/icons/ak47.svg" alt="AK47" class="weapon-icon">';
            } else if (weapon.includes('m4a1') && !weapon.includes('silencer')) {
                return '<img src="images/icons/m4a1.svg" alt="M4A1" class="weapon-icon">';
            } else if (weapon.includes('m4a1_silencer')) {
                return '<img src="images/icons/m4a1_silencer.svg" alt="M4A1-S" class="weapon-icon">';
            } else if (weapon.includes('awp')) {
                return '<img src="images/icons/awp.svg" alt="AWP" class="weapon-icon">';
            } else if (weapon.includes('famas')) {
                return '<img src="images/icons/famas.svg" alt="FAMAS" class="weapon-icon">';
            } else if (weapon.includes('galilar')) {
                return '<img src="images/icons/galilar.svg" alt="Galil AR" class="weapon-icon">';
            } else if (weapon.includes('aug')) {
                return '<img src="images/icons/aug.svg" alt="AUG" class="weapon-icon">';
            } else if (weapon.includes('sg556')) {
                return '<img src="images/icons/sg556.svg" alt="SG 556" class="weapon-icon">';
            } else if (weapon.includes('scar20')) {
                return '<img src="images/icons/scar20.svg" alt="SCAR-20" class="weapon-icon">';
            } else if (weapon.includes('g3sg1')) {
                return '<img src="images/icons/g3sg1.svg" alt="G3SG1" class="weapon-icon">';
            } else if (weapon.includes('ssg08')) {
                return '<img src="images/icons/ssg08.svg" alt="SSG 08" class="weapon-icon">';
            } else if (weapon.includes('nova')) {
                return '<img src="images/icons/nova.svg" alt="Nova" class="weapon-icon">';
            } else if (weapon.includes('xm1014')) {
                return '<img src="images/icons/xm1014.svg" alt="XM1014" class="weapon-icon">';
            } else if (weapon.includes('mag7')) {
                return '<img src="images/icons/mag7.svg" alt="MAG-7" class="weapon-icon">';
            } else if (weapon.includes('sawedoff')) {
                return '<img src="images/icons/sawedoff.svg" alt="Sawed-Off" class="weapon-icon">';
            } else if (weapon.includes('m249')) {
                return '<img src="images/icons/m249.svg" alt="M249" class="weapon-icon">';
            } else if (weapon.includes('negev')) {
                return '<img src="images/icons/negev.svg" alt="Negev" class="weapon-icon">';
            } else if (weapon.includes('mac10')) {
                return '<img src="images/icons/mac10.svg" alt="MAC-10" class="weapon-icon">';
            } else if (weapon.includes('mp7')) {
                return '<img src="images/icons/mp7.svg" alt="MP7" class="weapon-icon">';
            } else if (weapon.includes('mp9')) {
                return '<img src="images/icons/mp9.svg" alt="MP9" class="weapon-icon">';
            } else if (weapon.includes('p90')) {
                return '<img src="images/icons/p90.svg" alt="P90" class="weapon-icon">';
            } else if (weapon.includes('ump')) {
                return '<img src="images/icons/ump45.svg" alt="UMP-45" class="weapon-icon">';
            } else if (weapon.includes('bizon')) {
                return '<img src="images/icons/bizon.svg" alt="PP-Bizon" class="weapon-icon">';
            }
            
            // Secondary weapons (pistols)
            else if (weapon.includes('deagle')) {
                return '<img src="images/icons/deagle.svg" alt="Desert Eagle" class="weapon-icon">';
            } else if (weapon.includes('elite')) {
                return '<img src="images/icons/elite.svg" alt="Dual Berettas" class="weapon-icon">';
            } else if (weapon.includes('fiveseven')) {
                return '<img src="images/icons/fiveseven.svg" alt="Five-SeveN" class="weapon-icon">';
            } else if (weapon.includes('glock')) {
                return '<img src="images/icons/glock.svg" alt="Glock-18" class="weapon-icon">';
            } else if (weapon.includes('p250')) {
                return '<img src="images/icons/p250.svg" alt="P250" class="weapon-icon">';
            } else if (weapon.includes('cz75a')) {
                return '<img src="images/icons/cz75a.svg" alt="CZ75-Auto" class="weapon-icon">';
            } else if (weapon.includes('usp_silencer')) {
                return '<img src="images/icons/usp_silencer.svg" alt="USP-S" class="weapon-icon">';
            } else if (weapon.includes('revolver')) {
                return '<img src="images/icons/revolver.svg" alt="R8 Revolver" class="weapon-icon">';
            } else if (weapon.includes('tec9')) {
                return '<img src="images/icons/tec9.svg" alt="Tec-9" class="weapon-icon">';
            } else if (weapon.includes('hkp2000')) {
                return '<img src="images/icons/hkp2000.svg" alt="P2000" class="weapon-icon">';
            }
            
            // Melee weapons
            else if (weapon.includes('knife') || weapon.includes('bayonet')) {
                return '<img src="images/icons/knife.svg" alt="Knife" class="weapon-icon">';
            } else if (weapon.includes('taser')) {
                return '<img src="images/icons/taser.svg" alt="Zeus x27" class="weapon-icon">';
            }
            
            // Grenades and utilities
            else if (weapon.includes('grenade') || weapon.includes('hegrenade')) {
                return '<img src="images/icons/hegrenade.svg" alt="HE Grenade" class="weapon-icon">';
            } else if (weapon.includes('flashbang')) {
                return '<img src="images/icons/flashbang.svg" alt="Flashbang" class="weapon-icon">';
            } else if (weapon.includes('smokegrenade')) {
                return '<img src="images/icons/smokegrenade.svg" alt="Smoke Grenade" class="weapon-icon">';
            } else if (weapon.includes('molotov')) {
                return '<img src="images/icons/molotov.svg" alt="Molotov" class="weapon-icon">';
            } else if (weapon.includes('decoy')) {
                return '<img src="images/icons/decoy.svg" alt="Decoy Grenade" class="weapon-icon">';
            } else if (weapon.includes('incgrenade')) {
                return '<img src="images/icons/incgrenade.svg" alt="Incendiary Grenade" class="weapon-icon">';
            }
            
            // Default icon for unknown weapons
            return '<i class="fas fa-crosshairs"></i>';
        }

        function createPlayerCard(player) {
            const health = player.health || 0;
            const name = player.name || 'Unknown Player';
            const money = player.money || 0;
            const armor = player.armor || 0;
            const modelName = player.modelName || '';
            const ping = player.ping || 0;
            const kills = player.kills || 0;
            const isDead = health === 0;
            const healthClass = getHealthClass(health);
            const characterImage = getCharacterImage(modelName);
            const isTerrorist = player.team === 2; // Assuming 2 = T, 3 = CT

            return `
                <div class="player-card ${isDead ? 'dead' : ''}" data-player="${name}">
                    <div class="player-header">
                        <div class="player-avatar">
                            <img src="${characterImage}" alt="${name}" onerror="this.src='images/characters/ctm_fbi.png'">
                        </div>
                        <div class="player-info">
                            <div class="player-name">${name}</div>
                            <div class="player-weapon-display">
                                ${player.weapons && player.weapons.active ? getWeaponIcon(player.weapons.active) : ''}
                            </div>
                        </div>
                        <div class="player-stats-top">
                            <div class="player-ping">${ping}ms</div>
                            <div class="player-kills">${kills} kills</div>
                        </div>
                    </div>
                    
                    <div class="player-stats">
                        <div class="player-money">$${money.toLocaleString()}</div>
                        <div class="player-health-armor">
                            <div class="health-indicator">
                                <i class="fas fa-heart"></i>
                                <span>${health}</span>
                        </div>
                            <div class="armor-indicator">
                                <i class="fas fa-shield-alt"></i>
                                <span>${armor}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="weapons-row">
                        <div class="weapon-slot" title="Equipment"></div>
                        <div class="weapon-slot ${player.armor > 0 ? 'armor' : ''}" title="Armor: ${player.armor}">
                            <img src="images/icons/kevlar.svg" alt="Armor" class="weapon-icon">
                        </div>
                        <div class="weapon-slot ${player.hasHelmet ? 'helmet' : ''}" title="Helmet: ${player.hasHelmet ? 'Yes' : 'No'}">
                            <img src="images/icons/kevlar_helmet.svg" alt="Helmet" class="weapon-icon">
                        </div>
                        <div class="weapon-slot ${player.hasDefuser ? 'defuser' : ''}" title="Defuser: ${player.hasDefuser ? 'Yes' : 'No'}">
                            <img src="images/icons/defuser.svg" alt="Defuser" class="weapon-icon">
                        </div>
                        <div class="weapon-slot" title="Equipment"></div>
                    </div>
                </div>
            `;
        }

        // Kill feed management
        let killFeedEntries = [];
        const maxKillFeedEntries = 5;
        let previousPlayerData = {}; // Track previous player data to detect changes

        function addKillFeedEntry(killerName, weaponName, victimName = null) {
            const killFeed = document.getElementById('killFeed');
            if (!killFeed) return;

            // Create kill feed entry
            const entry = document.createElement('div');
            entry.className = 'kill-feed-entry';
            
            const weaponIcon = getWeaponIcon(weaponName);
            
            if (victimName) {
                // Show attacker weapon victim
                entry.innerHTML = `
                    <span class="player-name">${killerName}</span>
                    <div class="weapon-icon">${weaponIcon}</div>
                    <span class="victim-name">${victimName}</span>
                `;
            } else {
                // Show attacker weapon +1
                entry.innerHTML = `
                    <span class="player-name">${killerName}</span>
                    <div class="weapon-icon">${weaponIcon}</div>
                    <span class="kill-count">+1</span>
                `;
            }

            // Add to kill feed
            killFeed.appendChild(entry);
            killFeedEntries.push(entry);

            // Remove old entries if we exceed the limit
            if (killFeedEntries.length > maxKillFeedEntries) {
                const oldEntry = killFeedEntries.shift();
                if (oldEntry && oldEntry.parentNode) {
                    oldEntry.parentNode.removeChild(oldEntry);
                }
            }

            // Auto-remove entry after 5 seconds
            setTimeout(() => {
                if (entry.parentNode) {
                    entry.style.animation = 'killFeedSlideOut 0.3s ease-in forwards';
                    setTimeout(() => {
                        if (entry.parentNode) {
                            entry.parentNode.removeChild(entry);
                            killFeedEntries = killFeedEntries.filter(e => e !== entry);
                        }
                    }, 300);
                }
            }, 5000);
        }

        function updateKillFeed(players) {
            // Check for kill count changes by comparing with previous data
            players.forEach(player => {
                const previousData = previousPlayerData[player.name];
                
                if (previousData) {
                    // Check if player got a kill
                    if (player.kills > previousData.kills) {
                        // Player got a kill! Find their current weapon
                        const currentWeapon = player.weapons?.active || 'unknown';
                        
                        // Try to find who died (player whose health dropped to 0)
                        let victimName = null;
                        players.forEach(otherPlayer => {
                            if (otherPlayer.name !== player.name) {
                                const otherPreviousData = previousPlayerData[otherPlayer.name];
                                if (otherPreviousData && otherPreviousData.health > 0 && otherPlayer.health === 0) {
                                    victimName = otherPlayer.name;
                                }
                            }
                        });
                        
                        // Add kill feed entry
                        addKillFeedEntry(player.name, currentWeapon, victimName);
                        
                        console.log(`Kill detected: ${player.name} killed ${victimName || 'someone'} with ${currentWeapon}`);
                    }
                    
                    // Check if player died (health dropped to 0)
                    if (previousData.health > 0 && player.health === 0) {
                        console.log(`Player died: ${player.name}`);
                    }
                }
            });
            
            // Update previous data for next comparison
            players.forEach(player => {
                previousPlayerData[player.name] = {
                    kills: player.kills || 0,
                    health: player.health || 0,
                    weapons: player.weapons || {}
                };
            });
        }

        function updateTeamLists(players) {
            const terrorists = players.filter(p => p.team === 2);
            const counterTerrorists = players.filter(p => p.team === 3);

            // Update T team
            tCount.textContent = `${terrorists.length} players`;
            tPlayersList.innerHTML = terrorists.length > 0 
                ? terrorists.map(createPlayerCard).join('')
                : '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No terrorists detected</div>';

            // Update CT team
            ctCount.textContent = `${counterTerrorists.length} players`;
            ctPlayersList.innerHTML = counterTerrorists.length > 0 
                ? counterTerrorists.map(createPlayerCard).join('')
                : '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No counter-terrorists detected</div>';
        }

                // Listen for real-time updates
        database.ref('players').on('value', (snapshot) => {
            const data = snapshot.val();
            
            console.log('Firebase data received:', data);
            
            if (!data) {
                connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>Disconnected</span>';
                connectionStatus.className = 'status disconnected';
                tPlayersList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No players detected...</div>';
                ctPlayersList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No players detected...</div>';
                tCount.textContent = '0 players';
                ctCount.textContent = '0 players';
                return;
            }

            // Process player data - filter out non-player entries
            const players = Object.entries(data)
                .filter(([key, value]) => key.startsWith('player_') && value && typeof value === 'object')
                .map(([key, value]) => value)
                .sort((a, b) => (a.index || 0) - (b.index || 0));
            
            console.log('Processed players:', players);
            
            // Update connection status
            connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>Connected</span>';
            connectionStatus.className = 'status connected';
            
            // Update team lists
            updateTeamLists(players);
            
            // Update kill feed
            updateKillFeed(players);
            
            // Draw radar
            drawRadar(players);
        }, (error) => {
            connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>Disconnected</span>';
            connectionStatus.className = 'status disconnected';
            console.error('Error listening to Firebase:', error);
        });

        // Function to change background image based on map
        function changeBackgroundImage(mapName) {
            if (!mapName || mapName === 'invalid' || mapName.includes('<empty>')) {
                mapName = 'de_dust2'; // Fallback to dust2
            }
            
            const body = document.body;
            const backgroundUrl = `images/data/${mapName}/background.png`;
            
            // Check if image exists before changing
            const img = new Image();
            img.onload = function() {
                body.style.setProperty('--background-image', `url('${backgroundUrl}')`);
                body.style.setProperty('--background-opacity', '0.3');
                console.log(`Background changed to: ${mapName}`);
            };
            img.onerror = function() {
                // Fallback to dust2 if image doesn't exist
                body.style.setProperty('--background-image', `url('images/data/de_dust2/background.png')`);
                body.style.setProperty('--background-opacity', '0.3');
                console.log(`Background fallback to: de_dust2 (${mapName} not found)`);
            };
            img.src = backgroundUrl;
        }

        // Initialize background and map data on page load
        function initializeBackground() {
            // Set initial map
            currentMapName = 'de_dust2';
            
            // Load initial map data
            fetch(`images/data/${currentMapName}/data.json`)
                .then(response => response.json())
                .then(mapData => {
                    currentMapData = mapData;
                    console.log(`Initial map data loaded for ${currentMapName}:`, mapData);
                })
                .catch(error => {
                    console.error(`Failed to load initial map data for ${currentMapName}:`, error);
                    currentMapData = { x: -2476, y: 3239, scale: 4.4 }; // Fallback
                });
            
            // Set initial background and radar
            changeBackgroundImage(currentMapName);
            
            // Set initial radar image
            const radarImage = document.getElementById('radarImage');
            if (radarImage) {
                radarImage.src = `images/data/${currentMapName}/radar.png`;
            }
        }

        // Function to change map when dropdown selection changes
        function changeMap(mapName) {
            console.log(`Map changed to: ${mapName}`);
            
            // Update current map name
            currentMapName = mapName;
            
            // Change background image
            changeBackgroundImage(mapName);
            
            // Load the correct radar image for the selected map
            const radarImage = document.getElementById('radarImage');
            if (radarImage) {
                const radarImageUrl = `images/data/${mapName}/radar.png`;
                radarImage.src = radarImageUrl;
            }

            // Load map data for the selected map
            fetch(`images/data/${mapName}/data.json`)
                .then(response => response.json())
                .then(mapData => {
                    currentMapData = mapData;
                    console.log(`Map data loaded for ${mapName}:`, mapData);
                    
                    // Redraw radar with current players if any exist
                    if (currentPlayersForResize && currentPlayersForResize.length > 0) {
                        drawRadar(currentPlayersForResize);
                    }
                })
                .catch(error => {
                    console.error(`Failed to load map data for ${mapName}:`, error);
                    // Use default dust2 data as fallback
                    currentMapData = { x: -2476, y: 3239, scale: 4.4 };
                });
        }

                // Get radar position using the exact formula from the example
        function getRadarPosition(mapData, entityCoords) {
            if (!entityCoords.x || !entityCoords.y) {
                return { x: 0, y: 0 };
            }

            if (!mapData.x || !mapData.y) {
                return { x: 0, y: 0 };
            }

            const position = {
                x: (entityCoords.x - mapData.x) / mapData.scale / 1024,
                y: (((entityCoords.y - mapData.y) / mapData.scale) * -1.0) / 1024,
            };

            return position;
        }

        // Teammate colors from the example
        const playerColors = [
            "#84c8ed", // blue
            "#009a7d", // green
            "#eadd40", // yellow
            "#df7d29", // orange
            "#b72b92", // purple
            "#ffffff", // white
        ];

        // Store current players to prevent flickering
        let currentPlayersData = {};
        let currentMapData = null;
        let currentMapName = 'de_dust2';

        // Radar drawing function - fixed to prevent flickering and use exact example logic
        function drawRadar(players) {
            // Store players for resize handling
            currentPlayersForResize = players || [];
            const radarWrapper = document.getElementById('radarWrapper');
            const radarImage = document.getElementById('radarImage');
            if (!radarWrapper || !radarImage) {
                console.log('Radar elements not found');
                    return;
                }

            console.log('DrawRadar called with players:', players ? players.length : 0);

            // Initialize map data if not loaded
            if (!currentMapData) {
                currentMapData = { x: -2476, y: 3239, scale: 4.4 }; // Default dust2 data
                console.log('Using default map data');
            }



            // Get both wrapper and image bounding boxes for accurate positioning
            const radarWrapperBounding = radarWrapper.getBoundingClientRect();
            const radarImageBounding = radarImage.getBoundingClientRect();
            
            console.log('Radar wrapper bounds:', radarWrapperBounding);
            console.log('Radar image bounds:', radarImageBounding);
            
            // Calculate offset between wrapper and image (for centering)
            const imageOffsetX = radarImageBounding.left - radarWrapperBounding.left;
            const imageOffsetY = radarImageBounding.top - radarWrapperBounding.top;
            
            console.log('Image offset from wrapper:', { x: imageOffsetX, y: imageOffsetY });
            
            // Force layout recalculation to ensure accurate positioning after resize
            radarImage.offsetHeight;
            
            // Process players
            const newPlayersData = {};
            
            if (players && players.length > 0) {
                console.log('Processing players:', players.length);
                
                players.forEach((player, index) => {
                    console.log(`Processing player ${index}:`, {
                        name: player.name,
                        health: player.health,
                        position: player.position,
                        isEnemy: player.isEnemy
                    });

                    if (!player.position) {
                        console.log(`Skipping ${player.name} - no position`);
                return;
            }

                    if (player.health === 0) {
                        console.log(`Skipping ${player.name} - dead`);
                        return; // Skip dead players
                    }

                    const playerId = `${player.name}_${player.index || index}`;
                    const isEnemy = player.isEnemy;
                    const colorId = player.colorId || 0;

                    // Calculate radar position using the exact formula from the example
                    const radarPosition = getRadarPosition(currentMapData, player.position);
                    console.log(`Player ${player.name} radar position:`, radarPosition);
                    
                    // Don't skip based on radar position - let's see all positions for debugging
                    // if (radarPosition.x <= 0 && radarPosition.y <= 0) return;

                    // Calculate position relative to radar image, accounting for image position within wrapper
                    const playerX = imageOffsetX + (radarImageBounding.width * radarPosition.x); // Offset players to the right
                    const playerY = imageOffsetY + (radarImageBounding.height * radarPosition.y);

                    console.log(`Player ${player.name} screen position:`, { x: playerX, y: playerY });

                    newPlayersData[playerId] = {
                        player: player,
                        position: { x: playerX, y: playerY },
                        radarPosition: radarPosition,
                        isEnemy: isEnemy,
                        colorId: colorId
                    };
                });
                
                console.log('Processed players data:', newPlayersData);
            } else {
                console.log('No players to process');
            }

            // Update existing players or create new ones
            Object.keys(newPlayersData).forEach(playerId => {
                const playerData = newPlayersData[playerId];
                let playerDot = document.getElementById(`radar-player-${playerId}`);

                console.log(`Updating player ${playerId}:`, playerData);

                if (!playerDot) {
                    console.log(`Creating new player dot for ${playerId}`);
                    
                    // Create container for both name and dot
                    playerDot = document.createElement('div');
                    playerDot.id = `radar-player-${playerId}`;
                    playerDot.className = 'radar-player-container';
                    playerDot.style.position = 'absolute';
                    playerDot.style.transform = 'translate(-50%, -50%)';
                    
                    // Create player name (stays fixed, doesn't rotate)
                    const playerName = document.createElement('div');
                    playerName.className = 'radar-player-name';
                    playerName.textContent = playerData.player.name;
                    playerDot.appendChild(playerName);
                    
                    // Create weapon display (stays fixed, doesn't rotate)
                    const playerWeapon = document.createElement('div');
                    playerWeapon.className = 'radar-player-weapon';
                    if (playerData.player.weapons && playerData.player.weapons.active) {
                        playerWeapon.innerHTML = getWeaponIcon(playerData.player.weapons.active);
                    }
                    playerDot.appendChild(playerWeapon);
                    
                    // Create health bar (stays fixed, doesn't rotate)
                    const playerHealthBar = document.createElement('div');
                    playerHealthBar.className = 'radar-player-health';
                    const healthPercent = Math.max(playerData.player.health || 0, 1);
                    const healthClass = getHealthClass(playerData.player.health || 0);
                    playerHealthBar.innerHTML = `<div class="radar-health-bar ${healthClass}" style="width: ${healthPercent}%;"></div>`;
                    playerDot.appendChild(playerHealthBar);
                    
                    // Create the actual teardrop (this will rotate)
                    const playerTeardrop = document.createElement('div');
                    playerTeardrop.className = `radar-player-teardrop ${playerData.isEnemy ? 'enemy' : 'teammate'}`;
                    
                    // Set player color for teammates
                    if (!playerData.isEnemy) {
                        const color = playerColors[playerData.colorId % playerColors.length] || playerColors[0];
                        playerTeardrop.style.backgroundColor = color;
                        playerTeardrop.style.color = color;
                        console.log(`Set teammate color: ${color}`);
                    } else {
                        console.log('Created enemy player');
                    }

                    playerDot.appendChild(playerTeardrop);
                    radarWrapper.appendChild(playerDot);
                    console.log(`Added player ${playerId} to radar`);
                } else {
                    console.log(`Updating existing player ${playerId}`);
                }

                // Update position (EXACT example positioning logic)
                playerDot.style.left = `${playerData.position.x}px`;
                playerDot.style.top = `${playerData.position.y}px`;
                playerDot.style.display = 'block'; // Make sure it's visible
                
                console.log(`Positioned player ${playerId} at (${playerData.position.x}, ${playerData.position.y})`);

                // Update teardrop rotation based on view angles (name stays fixed)
                // Game uses -180 to 180 degrees, convert to proper CSS rotation
                const playerTeardrop = playerDot.querySelector('.radar-player-teardrop');
                if (playerTeardrop) {
                    let rawAngle = 0;
                    let angleSource = 'default';
                    
                    if (playerData.player.viewAngles && playerData.player.viewAngles.pitch !== undefined) {
                        rawAngle = playerData.player.viewAngles.pitch;
                        angleSource = 'viewAngles.pitch';
                    } else if (playerData.player.pitch !== undefined) {
                        rawAngle = playerData.player.pitch;
                        angleSource = 'pitch';
                    } else if (playerData.player.angle !== undefined) {
                        rawAngle = playerData.player.angle;
                        angleSource = 'angle';
                    } else {
                        rawAngle = 315; // Default fallback
                        angleSource = 'default';
                    }
                    
                    // Convert game angle (-180 to 180) to CSS rotation
                    // Game: -180 = pointing left, 0 = pointing up, 180 = pointing right
                    // CSS: 0 = pointing right, 90 = pointing down, 180 = pointing left, 270 = pointing up
                    const ROTATION_OFFSET = 40; // Adjust this value to fine-tune direction accuracy
                    
                    let playerViewAngle;
                    let normalizedAngle = rawAngle; // Declare outside for debugging
                    
                    if (angleSource === 'default') {
                        playerViewAngle = rawAngle; // Use default as-is
                    } else {
                        // First normalize the raw angle to 0-360 range to handle negatives properly
                        while (normalizedAngle < 0) normalizedAngle += 360;
                        while (normalizedAngle >= 360) normalizedAngle -= 360;
                        
                        // Flip left/right by inverting the angle (mirror horizontally)
                        normalizedAngle = (180 - normalizedAngle) % 180;
                        
                        // Then apply offset
                        playerViewAngle = normalizedAngle + ROTATION_OFFSET;
                        
                        // Final normalization
                        while (playerViewAngle < 0) playerViewAngle += 360;
                        while (playerViewAngle >= 360) playerViewAngle -= 360;
                    }
                    
                    playerTeardrop.style.transform = `rotate(${playerViewAngle}deg)`;
                    if (angleSource !== 'default') {
                        console.log(`Player ${playerId} rotation: ${rawAngle} (raw)  ${normalizedAngle} (normalized)  ${playerViewAngle} (final) from ${angleSource}`);
                    } else {
                        console.log(`Player ${playerId} rotation: ${playerViewAngle}deg from ${angleSource}: ${rawAngle}`);
                    }
                }

                // Update weapon display for existing players
                const playerWeapon = playerDot.querySelector('.radar-player-weapon');
                if (playerWeapon && playerData.player.weapons && playerData.player.weapons.active) {
                    playerWeapon.innerHTML = getWeaponIcon(playerData.player.weapons.active);
                } else if (playerWeapon) {
                    playerWeapon.innerHTML = '';
                }

                // Update health bar for existing players
                const playerHealthBar = playerDot.querySelector('.radar-player-health');
                if (playerHealthBar) {
                    const healthPercent = Math.max(playerData.player.health || 0, 1);
                    const healthClass = getHealthClass(playerData.player.health || 0);
                    playerHealthBar.innerHTML = `<div class="radar-health-bar ${healthClass}" style="width: ${healthPercent}%;"></div>`;
                }
            });
            
            console.log(`Total players on radar: ${Object.keys(newPlayersData).length}`);

            // Remove players that no longer exist
            Object.keys(currentPlayersData).forEach(playerId => {
                if (!newPlayersData[playerId]) {
                    const playerDot = document.getElementById(`radar-player-${playerId}`);
                    if (playerDot) {
                        playerDot.remove();
                    }
                }
            });

            currentPlayersData = newPlayersData;
        }

        // Initialize background and add loading animation while connecting
        initializeBackground();
        connectionStatus.innerHTML = '<div class="loading"></div><span>Connecting...</span>';
        
        // Store current players for resize handling
        let currentPlayersForResize = [];

        // Handle window resize for radar - recalculate all player positions
        let resizeTimer;
        window.addEventListener('resize', () => {
            console.log('Window resized, recalculating player positions');
            
            // Clear any existing timer to debounce resize events
            clearTimeout(resizeTimer);
            
            // Set a new timer with shorter delay
            resizeTimer = setTimeout(() => {
                if (currentPlayersForResize.length > 0) {
                    console.log('Redrawing radar after resize');
                    drawRadar(currentPlayersForResize);
                }
            }, 50); // Reduced delay for more responsive resize
        });
    </script>
</body>
</html>
